<html>
<head>
<link rel="stylesheet" href="codemirror.css">
<link rel="stylesheet" href="foldgutter.css">
<script src="codemirror.js"></script>
<script src="matchbrackets.js"></script>
<script src="continuecomment.js"></script>
<script src="comment.js"></script>
<script src="foldcode.js"></script>
<script src="javascript.js"></script>
<script src="sql.js"></script>
<script src="foldgutter.js"></script>
<script src="brace-fold.js"></script>
<script src="json-formatter-js.js"></script>
<script src="railroad.js"></script>
<script src="jslint.js"></script>
<script>
/* user application */
root.context =	{
		title:"notset",
		href:true,
		dochref:"doc"
	};
root.Railroad.call(this,root,
	{ // those will be Diagram options
	VERTICAL_SEPARATION: 8,
	ARC_RADIUS: 10,
	DIAGRAM_CLASS: 'railroad-diagram',
	STROKE_ODD_PIXEL_LENGTH: true,
	INTERNAL_ALIGNMENT: 'center',
	},
	root.context
);
</script>
<style>
.hidden{
	display: none;
}
a.svg {
  position: relative;
  display: inline-block;
}
svg.railroad-diagram {
    background-color: hsl(30,20%,95%);
}
svg.railroad-diagram path {
    stroke-width: 3;
    stroke: black;
    fill: rgba(0,0,0,0);
}
svg.railroad-diagram text {
    font: bold 14px monospace;
    text-anchor: middle;
}
svg.railroad-diagram text.diagram-text {
    font-size: 12px;
}
svg.railroad-diagram text.diagram-arrow {
    font-size: 16px;
}
svg.railroad-diagram text.label {
    text-anchor: start;
}
svg.railroad-diagram text.comment {
    font: italic 12px monospace;
}
svg.railroad-diagram g.non-terminal text {
    /*font-style: italic;*/
}
svg.railroad-diagram rect {
    stroke-width: 3;
    stroke: black;
    fill: hsl(120,100%,90%);
}
svg.railroad-diagram path.diagram-text {
    stroke-width: 3;
    stroke: black;
    fill: white;
    cursor: help;
}
svg.railroad-diagram g.diagram-text:hover path.diagram-text {
    fill: #eee;
}
input[type=checkbox]:checked + div {
  display: none;
}
.homeLink{
  background-color: #E4F5F8;
  border:1px solid #C0DEED; 
  text-decoration:none; 
}
header,
section,
aside,
nav,
footer {
  /* margin: 0 1.5% 24px 1.5%; */
}
section {
  float: left;
  width: 63%;
}
aside {
  float: right;
  width: 30%;
}
header{
  color:white;
  background-color:lightgrey;	
}
footer {
  clear: both;
  margin-bottom: 0;
  color:white;
  background-color:grey;
}
</style>
</head>
<body  onload="refresh()">
<div class="container">

<header>
<h1>railroad-diagram</h1>
</header>
<nav>
<button id="showhide" onclick="showhide();">show/hide</button>
<select id="items" onchange="goToItem()"></select>
<button id="switch" onclick="doswitch();">switch</button>
<button id="validate" onclick="dovalidate();">validate</button>
<button id="refresh" onclick="refresh();">refresh</button>
</nav>
<div>
<input type='checkbox' id='home'/>home(+/-)<div>
<div id="editor">
<textarea id="graphin" cols='150' rows='25'>
/********************************************************************************************************************************/
Show(Stack(Title("CREATE TABLE"),
  Sequence(Terminal('CREATE'),Choice(0,Skip(),Terminal('TEMP'),Terminal('TEMPORARY')),Terminal('TABLE'),
           Choice(0,Skip(),Sequence(Terminal('IF'),Terminal('NOT'),Terminal('EXISTS'))
  ) /* sequence */
),Sequence(Optional(Sequence(NonTerminal('schema-name'),Terminal("."))),NonTerminal('table-name')), /* sequence */
Sequence(
 Choice(0,
  Sequence(Terminal("("),OneOrMore(NonTerminal("column-def"),Terminal(",")),
           ZeroOrMore(Terminal(","),NonTerminal("table-constraint")),
           Terminal(")"),Optional(Sequence(Terminal("WITHOUT"),Terminal("ROWID")))),
  Sequence(Terminal("AS"),NonImplemented("select-stm"))
 ) /* choice */
),
Comment("END CREATE TABLE")) /* Stack */
); /* Create Table */
/********************************************************************************************************************************/
Show(
Sequence(Title("schema-name"),
NonTerminal('name'),Comment("END schema-name")
) 
); /* schema name */
/********************************************************************************************************************************/
Show(
Sequence(Title("table-name"),NonTerminal('name'),Comment('END table-name')
)
); /* tables name */
/********************************************************************************************************************************/
Show(
Sequence(Title("column-def"),NonTerminal("column-name"),Optional(NonTerminal("type-name")),ZeroOrMore(NonTerminal("column-constraint")),
Comment("END column-def")
)
); /* column def */
/********************************************************************************************************************************/
Show(
Sequence(Title("column-name"),NonTerminal('name'),Comment('END column-name')
)
); /* column name */
/********************************************************************************************************************************/
Show(
Sequence(Title("name"),
Choice(0,
	Terminal('/(^[A-Za-z][A-Za-z0-9_]*)/'),
	Terminal('/(^\\"[A-Za-z][A-Za-z0-9_\\s]*)\\"/'),
        Terminal("/(^\\'[A-Za-z][A-Za-z0-9_\\s]*)\\'/")
),
Comment("END name")
)
); /* name */
/********************************************************************************************************************************/
Show(Stack(
  Title("column-constraint"),
  Optional(Sequence(Terminal("CONSTRAINT"),NonTerminal("name"))),
  Sequence(Choice(0,
         Sequence(Terminal("PRIMARY"),Terminal("KEY"),Choice(0,Skip(),Terminal("ASC"),Terminal("DESC")),NonTerminal("conflict-clause"),Optional(Terminal("AUTOINCREMENT"))),
         Sequence(Terminal("NOT"),Terminal("NULL"),NonTerminal("conflict-clause")),
         Sequence(Terminal("UNIQUE"),NonTerminal("conflict-clause")),
         Sequence(Terminal("CHECK"),Terminal("("),NonImplemented("expr"),Terminal(")")),
         Sequence(Terminal("DEFAULT"),Choice(0,NonTerminal("signed-number"),NonTerminal("literal-value"),Sequence(Terminal("("),NonImplemented("expr"),Terminal(")")))),
         Sequence(Terminal("COLLATE"),Terminal("collation-name")),
         NonTerminal("foreign-key-clause")
        )),
  Comment("END column-constraint")
  )
); /* column-constraint */
/********************************************************************************************************************************/
Show(Sequence(Title("conflict-clause"),
     Optional(Sequence(Terminal("ON"),Terminal("CONFLICT"),
                                                Choice(0,
                                                       Terminal("ROLLBACK"),
                                                       Terminal("ABORT"),
                                                       Terminal("FAIL"),
                                                       Terminal("IGNORE"),
                                                       Terminal("REPLACE"))
                                               )
                                      ),Comment("END conflict-clause"))
    ); /* conflict-clause */
/********************************************************************************************************************************/
Show(Stack(Title("table-constraint"),Stack(Optional(Sequence(Terminal("CONSTRAINT"),NonTerminal("name"))),
                                     Choice(0,Sequence(Choice(0,Sequence(Terminal("PRIMARY"),Terminal("Key")),Terminal("UNIQUE")),Terminal("("),
                                                       OneOrMore(NonTerminal("indexed-column"),Terminal(",")),Terminal(")"),NonTerminal("conflict-clause")),
                                            Sequence(Terminal("CHECK"),Terminal("("),NonImplemented("expr"),Terminal(")")),
                                            Sequence(Terminal("FOREIGN"),Terminal("KEY"),Terminal("("),
                                                     OneOrMore(NonTerminal("column-name"),Terminal(",")),Terminal(")"),
                                                     NonTerminal("foreign-key-clause"))
                                           )                                          
     ),
     Comment("END table-constrainte"))
); /* table-constraint */
/********************************************************************************************************************************/
Show(Stack(Title("indexed-column"),
     Sequence(Choice(0,NonTerminal("column-name"),NonImplemented("expr")),
              Optional(Sequence(Terminal("COLLATE"),NonTerminal("collation-name"))),
              Choice(0,Skip(),Terminal("ASC"),Terminal("DESC"))),
     Comment("END indexed-column"))
    ); /* indexed-column */
/********************************************************************************************************************************/
Show(Stack(Title("type-name"),
           Sequence(NonTerminal("name"),Choice(0,
                                                       Skip(),
                                                       Sequence(Terminal("("),NonTerminal("signed-number"),Terminal(")")),
                                                       Sequence(Terminal("("),NonTerminal("signed-number"),Terminal(","),NonTerminal("signed-number"),Terminal(")"))
                                                      )
                   ),
           Comment("END type-name"))
    ); /* type-name */ 
/********************************************************************************************************************************/
Show(Stack(Title("numeric-literal"),
           Sequence(Choice(0,Choice(0,Sequence(Choice(0,Sequence(Terminal("/[0-9]+/"),Optional(Sequence(Terminal("."),Terminal("/[0-9]+/")))),
                                                      Sequence(Terminal("."),Terminal("/[0-9]+/"))
                                                     ),
                                               Optional(Sequence(Terminal("E"),
                                                                 Choice(0,Skip(),Terminal("+"),Terminal("-")),Terminal("/[0-9]+/")))
                                              )
                                   ),
                           Sequence(Terminal("0x"),Terminal("/[A-Za-z0-9]+)/"))
                          )
                   ),
           Comment("END numeric-literal"))
    ); /* numeric-literal */
/********************************************************************************************************************************/
Show(Sequence(Title("signed-number"),Optional(Choice(0,Terminal("+"),Terminal("-"))),NonTerminal("numeric-literal"),Comment("END signed-number"))
    ); /* signed-number */ 
/********************************************************************************************************************************/
Show(Stack(Title("foreign-key-clause"),
           Sequence(Terminal("REFERENCES"),NonTerminal("foreign-table"),
                    Optional(Sequence(Terminal("("),OneOrMore(NonTerminal("column-name"),Terminal(",")),Terminal(")")))),
           Stack(ZeroOrMore(
                          Choice(0,
                                 Sequence(Terminal("ON"),
                                          Choice(0,Terminal("DELETE"),Terminal("UPDATE")),
                                          Choice(0,
                                                 Sequence(Terminal("SET"),Choice(0,Terminal("NULL"),Terminal("DEFAULT"))),
                                                 Terminal("CASCADE"),
                                                 Terminal("RESTRICT"),
                                                 Sequence(Terminal("NO"),Terminal("ACTION"))
                                                )
                                         ),
                                 Sequence(Terminal("MATCH"),NonTerminal("name"))
                                )
                          ),
                          Optional(Sequence(Optional(Terminal("NOT")),Terminal("DEFERRABLE"),
                                           Choice(0,Skip(),Sequence(Terminal("INITIALLY"),
                                                                    Choice(0,Terminal("DEFFERED"),Terminal("IMMEDIATE"))
                                                                   )
                                                 )
                                           )
                                  )
                   ),
           Comment("END foreign-key-clause")
          )
    ); /* foreign-key-clause" */
/********************************************************************************************************************************/
Show(Sequence(Title("foreign-table"),NonTerminal("table-name"),Comment("END foreign-table"))
    ); /* foreign-table */
              
</textarea>
</div >
<div id="sql">
<textarea id="sqleditor" cols="50" rows="25">
CREATE TABLE "Customer" (
  "IdCustomer" text NULL,
  "CompanyName" text NULL,
  "ContactName" text NULL,
  "ContactTitle" text NULL,
  "Address" text NULL,
  "City" text NULL,
  "Region" text NULL,
  "PostalCode" text NULL,
  "Country" text NULL,
  "Phone" text NULL,
  "Fax" text NULL,
  PRIMARY KEY ("IdCustomer")
)
</textarea>
</div>
</div>
<div id="error">
</div>
<div id="result">
</div>
<footer>Copyright &copy; Gilbert Brault 2016</footer>
<script>

window.editor = CodeMirror.fromTextArea(document.getElementById("graphin"), {
		mode: "javascript",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
        continueComments: "Enter",       
});

window.sql = CodeMirror.fromTextArea(document.getElementById("sqleditor"), {
		mode: "sql",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
        continueComments: "Enter",       
});

var cmsql = document.getElementById("sql");
cmsql.setAttribute("class","hidden");
window.showstate="editor";
var validate=document.getElementById("validate");
validate.setAttribute("class","hidden");

function injectjs(content,error){
    var scriptref=document.createElement('script');
    scriptref.setAttribute("type","text/javascript");
    scriptref.innerText= content;
    if ((typeof scriptref!="undefined") && scriptref!=null){
    	try{
        	document.getElementsByTagName("head")[0].appendChild(scriptref);
    	} 	catch(e){
		error.innerHTML="<pre>"+
					    e.stack+"\n"+
						"</pre>";
	    }    
    }
    return scriptref;
}

function _Show(){
	if(this.state==="graphing"){
		try{		
			this.graph.push ((new Diagram([].slice.call(arguments))).format());
		}  	catch(e){
			this.error.innerHTML="<pre>"+
					    e.stack+"\n"+
						"</pre>";
	    }    
		this.title.push(this.context.title);
		this.context.title="notset";
	} else if(this.state==="walking"){
		this.walk.push (Diagram(arguments[0]));
	}
}

function refresh(){
	var error=document.getElementById('error');
	var result=document.getElementById('result');
	var select=document.getElementById('items');
	window.results={title:[],graph:[],walk:[],context:root.context,state:"notset",error:error};
	window.Show=_Show.bind(window.results);
	result.innerHTML="";
	error.innerHTML="";
	select.innerHTML="";
	var diags = window.editor.getValue();
	var scriptref;

	//jslint for errors
	var source = diags;
	source+="\nfunction Show(){}\n";
	for(var fn=0; fn<root.Railroad.fnames.length;fn++){
		source+="\nfunction "+root.Railroad.fnames[fn]+"(){}\n";
	}
	var jscheck = jslint(source);

	if(!jscheck.stop){

	// prepare graphing
	results.state='graphing';
	root.Railroad.SetExports(root.Railroad.graphing,root.Railroad.fnames);
	// comments should be within /* */  double // don't work
	try{
		scriptref = injectjs(diags,error);
	} catch(e){
		error.innerHTML="<pre>"+
					    e.stack+"\n"+
						"</pre>";
	}      
	scriptref.outerHTML="";

	// prepare json
	results.state='walking';
    root.Railroad.SetExports(root.Railroad.walking,root.Railroad.fnames);
    	try{
		scriptref = injectjs(diags);
	} catch(e){
		error.innerHTML="<pre>"+
					    e.stack+"\n"+
						"</pre>";
	}
	scriptref.outerHTML="";

    // render results
    for(var i=0; i<results.graph.length;i++){
    		var section = document.createElement('section');
	        // show/hide
	        var home=document.createElement('a');
	        home.setAttribute("href","#");
	        home.setAttribute("onclick","home()");
	        home.setAttribute("class","homeLink");
	        home.setAttribute("title","jump to top");
	        var lhome=document.createTextNode("^");
	        home.appendChild(lhome);
	        section.appendChild(home);           
    		var checkbox = document.createElement('input');
			checkbox.type = "checkbox";
			section.appendChild(checkbox);
			var clabel= ((results.title[i]!=="notset")?results.title[i]:"")+" (+/-)";
			if(context.title!=="notset"){
            	checkbox.setAttribute("id",results.title[i]);
            	var option = document.createElement("option");
				option.text = results.title[i];
				select.add(option);
        	} 
        	var label=document.createTextNode(clabel);
        	section.appendChild(label);
        	var div = document.createElement('div');
        	section.appendChild(div);
        	if(i<results.graph.length-1)
        		checkbox.checked=true;

    		// graphing
			var graphout = document.createElement('aside');           
            graphout.appendChild(results.graph[i].toSVG());           
            div.appendChild(graphout);    	
			// json tree
		    const formatter = new JSONFormatter(results.walk[i]);
            var elt = formatter.render();
            var walkout = document.createElement('article');                       
            walkout.appendChild(elt);
            div.appendChild(walkout);
			result.appendChild(section);
    } 
	} else {
		// display warnings
		var content="<pre>";		
		for(var i=0; i<jscheck.warnings.length; i++){
			var w = jscheck.warnings[i];
			content+=w.line+":"+w.column+" "+w.message+"\n";
		}
		content+="</pre>";
		error.innerHTML=content;
	}        
}

function showhide(){
	for(var i=0; i< window.results.title.length; i++){
		var chkbx = document.getElementById(window.results.title[i]);
		chkbx.checked = ! chkbx.checked;
	}
}

function home(){
	document.getElementById("home").scrollIntoView();  
}

function scrollto(h){
	document.getElementById(h).scrollIntoView();  
}

function goToItem(){
	var select = document.getElementById("items");
	var item = select.value;
	_goToItem(item);
}

function _goToItem(item){
	for(var i=0; i< window.results.title.length; i++){
		var chkbx = document.getElementById(window.results.title[i]);
		if(item!=window.results.title[i]){
			chkbx.checked = true;
		} else {
			chkbx.checked = false;
		}
		
	}	
}

function doc(type,node){
	if(type==="NonTerminal"){
		_goToItem(node);
	}
}

function tokenizer(str){
const regex = /"(?:\w|\s)+"|'(?:\w|\s)+'|\w+|[,.()]/gm;
var m;
var results=[];

while ((m = regex.exec(str)) !== null) {
    // This is necessary to avoid infinite loops with zero-width matches
    if (m.index === regex.lastIndex) {
        regex.lastIndex++;
    }
    
    // The result can be accessed through the `m`-variable.
    m.forEach((match, groupIndex) => {
        // console.log(`Found match, group ${groupIndex}: ${match}`);
        results.push(match);
    });
}
return results;	
}

function doswitch(){
	var cmsql=document.getElementById("sql");
	var cmrailroad=document.getElementById("editor");
	var validate=document.getElementById("validate");
	var refresh=document.getElementById("refresh");

    if(window.showstate==="editor"){
		cmsql.setAttribute("class","");
		cmrailroad.setAttribute("class","hidden");
		validate.setAttribute("class","");
		refresh.setAttribute("class","hidden");
		window.showstate="sql";
	} else if(window.showstate==="sql"){
		cmsql.setAttribute("class","hidden");
		cmrailroad.setAttribute("class","");
		validate.setAttribute("class","hidden");
		refresh.setAttribute("class","");	
		window.showstate="editor";		
	}
}

function dovalidate(){
	var sql = window.sql.getValue();
	var tokens = tokenizer(sql);
	var i;
	var walk;
	// now check if the path i.e. the tokens list is compatible with the selected graph
	// find the entry graph
    var select = document.getElementById("items");
	var item = select.value;
	for(i=0; i<window.results.title.length;i++){
		if(item===window.results.title[i]) break;
	}
	if(i<window.results.title.length){
		walk = window.results.walk[i];
		var walkindex = 0;
		var pathindex = 0;
		var context = {path:tokens,pathindex:pathindex,walk:walk,walkindex:walkindex};
		context.nonTerminals={};
		for(i=0; i<window.results.title.length;i++){
			context.nonTerminals[window.results.title[i]]=window.results.walk[i];
		}
		dowalk(context);
		return context;
	}
	return false;
}

function dowalk(context){
	if (context.walkindex>Object.keys(context.walk).length) return;
	var walknodetype = Object.keys(context.walk)[context.walkindex];
	switch(walknodetype){
		case 'Diagram':
		    if (context.stack===undefined){
		    	context.stack = [];
		    }
		    if(context.results===undefined){
		    	context.results=[];
		    }
		    context.stack.push({walk:context.walk,walkindex:context.walkindex});
		    context.walkindex=0;
		    context.walk=context.walk['Diagram'][0];		    
		    dowalk(context);
		    var restore = context.stack.pop();
		    context.walk=restore.walk;
		    context.walkindex=restore.walkindex;
		    context.walkindex++;
		    return;
			break;
		case 'Title':
		    if(context.titles===undefined){
		    	context.titles=[];
		    }
		    context.titles.push(context.walk['Title'][0]);
		    context.walkindex++;
		    break;
		 case 'Terminal':
		    if(context.pathindex<context.path.length){
		    	context.results={type:'Terminal',walkvalue:context.walk.Terminal[0],pathvalue:context.path[context.pathindex]};		    	
		    	if(context.walk.Terminal[0].startsWith("/")){
                  	const regex = new RegExp(context.walk.Terminal[0]);
					var m;

					if ((m = regex.exec(context.path[context.pathindex])) !== null) {
    					// The result can be accessed through the `m`-variable.
    					// m.forEach((match, groupIndex) => {
        					// console.log(`Found match, group ${groupIndex}: ${match}`);
    					// });    				
					} else {
						context.error={state:true,message:"Terminal not matching see results for more information"};
					}
		    	} else {
		    		var feedback = context.results.walkvalue==context.results.pathvalue;
		    		if(!feedback){
		    			context.error={state:true,message:"Terminal not matching see results for more information"};
		    		}
		    	}
		    } else {
		    	context.results={type:'Terminal',walkvalue:context.walk.Terminal[0]}
		    	context.error={state:true,message:"ended prematurely"};
		    }
		    context.pathindex++;
		    break;
		 case 'Stack':
		 case 'Sequence':
		    for(var i=0; i<context.walk[walknodetype].length;i++){
		    	context.stack.push({walk:context.walk,walkindex:context.walkindex});
		    	context.walkindex=0;
		    	context.walk=context.walk[walknodetype][i];
		    	dowalk(context);
		        var restore = context.stack.pop();
		    	context.walk=restore.walk;
		    	context.walkindex=restore.walkindex;
		    	context.walkindex++;
		    	if(context.error!==undefined) break;
		    }
		    break;
		 case 'Choice':
		    var skip=false;
		    for(var i=1; i<context.walk[walknodetype].length;i++){
		    	context.stack.push({walk:context.walk,walkindex:context.walkindex});
		    	context.walkindex=0;
		    	context.walk=context.walk[walknodetype][i];
		    	if(context.walk.Skip===undefined){
					dowalk(context);
					if(context.error!==undefined){
						context.pathindex--;
						delete context.error;
					} else {
						break;
					}
		    	} else{
		    		skip = true;
		    	}		    	
		        var restore = context.stack.pop();
		    	context.walk=restore.walk;
		    	context.walkindex=restore.walkindex;
		    	context.walkindex++;		    	
		    }
		    if(skip) return;
		    context.error={state:true,message:"choice not satisfyed near"+context.path[context.pathindex]};
		    break;
		 case 'Optional':
		    var skip=false; 
		    context.stack.push({walk:context.walk,walkindex:context.walkindex});
		    context.walkindex=0;
		    context.walk=context.walk[walknodetype][0];
			dowalk(context);
			if(context.error!==undefined){
				context.pathindex--;
				delete context.error;
				skip=true;
			}	    	
	    	var restore = context.stack.pop();
		    context.walk=restore.walk;
		    context.walkindex=restore.walkindex;
		    if(!skip) context.walkindex++;		    			   	 
		 	break;
		 case 'NonTerminal':
		    if(context.nonTerminals[context.walk["NonTerminal"][0]]===undefined){
		    	context.error={state:true,message:"not existing NonTerminal"+context.walk["NonTerminal"][0]};
		    }
		    context.stack.push({walk:context.walk,walkindex:context.walkindex});
		    context.walk=context.nonTerminals[context.walk["NonTerminal"][0]];
		    dowalk(context);
		    var restore = context.stack.pop();
		    context.walk=restore.walk;
		    context.walkindex=restore.walkindex;
		    context.walkindex++;
		    if(context.error!==undefined) break;		    
		 	break;
		 default:
		    context.error={state:true,message:"wrong walk node type :"+walknodetype};
		 	return;
	}
}
</script>
</body>
</html>
