<!DOCTYPE html>
<html>
<title>SQLITE Grammar and Syntax validation</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="w3/w3.css">
<link rel="stylesheet" href="vis/vis.css">
<link rel="stylesheet" href="railroad.css">
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="codemirror/codemirror.css">
<link rel="stylesheet" href="codemirror/foldgutter.css">
<script src="w3/w3.js"></script>
<script src="codemirror/codemirror.js"></script>
<script src="codemirror/matchbrackets.js"></script>
<script src="codemirror/continuecomment.js"></script>
<script src="codemirror/comment.js"></script>
<script src="codemirror/foldcode.js"></script>
<script src="codemirror/javascript.js"></script>
<script src="codemirror/sql.js"></script>
<script src="codemirror/foldgutter.js"></script>
<script src="codemirror/brace-fold.js"></script>
<script src="vis/vis.js"></script>
<script src="railroad.js"></script>
<script src="SRFB.js"></script>
<script src="esprima.js"></script>
<style type="text/css">
  .border {
    border: 1px solid #d7d4f0;
  }
</style>
<body>
<!--
<nav class="w3-sidenav w3-light-grey" style="display:none" id="mySidenav">
  <a href="javascript:void(0)" 
  onclick="w3_close()"
  class="w3-closenav w3-large">Close &times;</a>
</nav>
-->

<header class="w3-container w3-teal">
  <!-- <span class="w3-opennav w3-xlarge w3-layout-cell" onclick="w3_open()">&#9776;</span> -->   
  <h1 class="w3-layout-cell" >&nbsp;SQLITE Grammar and Syntax validation</h1>
</header>
<div class="w3-container">
	<div class="w3-panel w3-card-2">
		<nav class="w3-navbar" >
			<small>
				<a id="a_error" href="#" onclick="toggleShow('error')" class="w3-btn w3-grey w3-text-white">{{error}}</a>
			</small>
		</nav>		
		<!-- errors output -->
		<div id="error" class="w3-container border">
		</div>
	</div>

	<div class="w3-panel w3-card-2">
		<nav class="w3-navbar" >
			<small>
				<a id="a_ebnfsrfb" href="#" onclick="toggleShow('ebnfsrfb')" class="w3-btn w3-grey w3-text-white">{{ebnfsrfb}}</a>
			</small>
		</nav>	
		<!-- ebnf srfb grammar editor (read from file) -->
		<div id="d_ebnfsrfb" class="w3-container">
			<textarea id="ebnfsrfb" cols='150' rows='25'>
			</textarea>
		</div>
	</div>

	<div class="w3-panel w3-card-2">
		<nav class="w3-navbar" >
			<small>
				<a id="a_ebnfsh" href="#" onclick="toggleShow('ebnfsh')" class="w3-btn w3-grey w3-text-white">{{ebnfsh}}</a>
				<a id="a_refresh" href="#" onclick="refreshebnf()" class="w3-btn w3-grey w3-text-white">refresh ebnf</a>
			</small>
		</nav>
		<!-- EBNF Railroad (generated) -->
		<div id="EBNFRailroad" class="w3-container border w3-responsive">
		</div>
	</div>

	
	<div class="w3-panel w3-card-2">
		<nav class="w3-navbar" >
			<small>
				<a id="a_ebnfsqlite" href="#" onclick="toggleShow('ebnfsqlite')" class="w3-btn w3-grey w3-text-white">{{ebnfsqlite}}</a>
			</small>
		</nav>	
		<!-- sqlite ebnf grammar editor (read from file) -->
		<div id="d_ebnfsqlite" class="w3-container">
			<textarea id="ebnfsqlite" cols='150' rows='25'>
			</textarea>
		</div>
	</div>
	
	<div class="w3-panel w3-card-2">
		<nav class="w3-navbar" >
			<small>
				<a id="a_sqlitesrfb" href="#" onclick="toggleShow('sqlitesrfb')" class="w3-btn w3-grey w3-text-white">{{sqlitesrfb}}</a>
				<a id="a_validate" href="#" onclick="validate()" class="w3-btn w3-grey w3-text-white">validate sqlite grammar</a>
			</small>
		</nav>	
		<!-- sqlite srfb grammar editor (generated) -->
		<div id="d_sqlitesrfb" class="w3-container border">
			<textarea id="sqlitesrfb" cols='150' rows='25'>
			</textarea>
		</div>
	</div>

	<div class="w3-panel w3-card-2">
		<nav class="w3-navbar" >
			<small>	
				<a id="a_sqlitesh" href="#" onclick="toggleShow('sqlitesh')" class="w3-btn w3-grey w3-text-white">{{sqlitesh}}</a>
				<a id="a_refresh" href="#" onclick="refreshsqlite()" class="w3-btn w3-grey w3-text-white">refresh sqlite</a>
			</small>
		</nav>	
		<!-- SQLITE Railroad (generated) -->
			<div id="SQLITERailroad" class="w3-container border w3-responsive">
		</div>
	</div>
	
	<div class="w3-panel w3-card-2">	
		<nav class="w3-navbar" >
			<small>
				<a id="a_sqlite" href="#" onclick="toggleShow('sqlite')" class="w3-btn w3-grey w3-text-white">{{sqlite}}</a>
			</small>
		</nav>	
		<!-- sqlite editor (read from file) -->
		<div id="d_sqlite" class="w3-container border">
			<textarea id="sqlite" cols='150' rows='25'>
			</textarea>
		</div>
	</div>
	<div id="de_compilegraph" class="w3-panel w3-card-2">	
    	<nav class="w3-navbar" >
			<small>
				<a id="a_validatesql" href="#" onclick="validatesql()" class="w3-btn w3-grey w3-text-white">validate sqlite expression</a>
				<a id="a_compilegraph" href="#" onclick="growshrink('compilegraph')" class="w3-btn w3-grey w3-text-white">{{compilegraph}}</a>
			</small>
		</nav>
		<div id="d_compilegraph" style="width:100%;height:100%;" >
			<!-- SQLITE validation (generated) -->
			<div id="VSQLITE" class="w3-container border w3-responsive" style="width:100%;height:100%;">
			</div>	
		</div>
	</div>
	
</div>

<footer class="w3-container w3-teal">
<small>Copyright &copy; Gilbert Brault 2016,2017
&nbsp;&nbsp;&nbsp;license&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://creativecommons.org/licenses/by/4.0/"><img src="images/cc.logo.white.svg" width="5%"/></a>
</small>
</footer>
     
<script>
/* start railroad processing */
/* user application */
root.context =	{
		title:"notset",
		href:true,
		dochref:"doc"
	};
root.Railroad.call(this,root,
	{ // those will be Diagram options
	VERTICAL_SEPARATION: 8,
	ARC_RADIUS: 10,
	DIAGRAM_CLASS: 'railroad-diagram',
	STROKE_ODD_PIXEL_LENGTH: true,
	INTERNAL_ALIGNMENT: 'center',
	},
	root.context
);
window.results={};
/*
function w3_open() {
    document.getElementById("mySidenav").style.width = "30%";
    document.getElementById("mySidenav").style.display = "block";
}
function w3_close() {
    document.getElementById("mySidenav").style.display = "none";
}
*/
var derror=true;
w3.displayObject("a_error",{error:"hide Error panel"});

window.e_ebnfsrfb = CodeMirror.fromTextArea(document.getElementById("ebnfsrfb"), {
		mode: "javascript",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
        continueComments: "Enter",	
});

w3.getHttpData("ebnf.js", function(text){
	window.e_ebnfsrfb.getDoc().setValue(text);
});
w3.displayObject("a_ebnfsrfb",{ebnfsrfb:"hide EBNF SRFB Editor"});
var ebnfsrfb=true;

window.e_ebnfsqlite = CodeMirror.fromTextArea(document.getElementById("ebnfsqlite"), {
		mode: "javascript",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        foldGutter: false,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
        continueComments: "Enter",	
});

w3.getHttpData("ebnfsqlite.txt", function(text){
	window.e_ebnfsqlite.getDoc().setValue(text);
});
w3.displayObject("a_ebnfsqlite",{ebnfsqlite:"hide EBNF SQLITE Editor"});
var ebnfsqlite=true;

var ebnfsh =true;
w3.displayObject("a_ebnfsh",{ebnfsh:"hide EBNF railroad"});

window.e_sqlitesrfb = CodeMirror.fromTextArea(document.getElementById("sqlitesrfb"), {
		mode: "javascript",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        foldGutter: false,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
        continueComments: "Enter",	
});

w3.displayObject("a_sqlitesrfb",{sqlitesrfb:"hide SQLITE SRFB grammar Editor"});
var sqlitesrfb=true;

var sqlitesh =true;
w3.displayObject("a_sqlitesh",{sqlitesh:"hide SQLITE railroad"});


window.e_sqlite = CodeMirror.fromTextArea(document.getElementById("sqlite"), {
		mode: "sql",
        lineNumbers: true,
        lineWrapping: true,
        matchBrackets: true,
        foldGutter: false,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
        continueComments: "Enter",	
});

w3.getHttpData("sqlite.txt", function(text){
	window.e_sqlite.getDoc().setValue(text);
});
w3.displayObject("a_sqlite",{sqlite:"hide SQLITE Editor"});
var sqlite=true;

w3.displayObject("a_compilegraph",{compilegraph:"Grow"});
var compilegraph=true;

function growshrink(id){
	eval("var a=window."+id+";");
	// w3.toggleShow("#d_"+id);
	if(a){
		eval("window."+id+"=false;");
		var l={};
		l[id]="Shrink";
		w3.displayObject("a_"+id,l);
		w3.addStyle("#de_"+id,'position','absolute');
		w3.addStyle("#de_"+id,'top',0);
		w3.addStyle("#de_"+id,'bottom',0);
		w3.addStyle("#de_"+id,'width','100%');
		w3.addStyle("#de_"+id,'height','100%');
		w3.addStyle("#de_"+id,'background-color','white');
		w3.addStyle("#de_"+id,'z-index',10);
	} else {
		eval("window."+id+"=true;");
		var l={};
		l[id]="Grow";
		w3.displayObject("a_"+id,l);
		w3.addStyle("#de_"+id,'position','inherit');
	}
}

function toggleShow(id){
	switch(id){
		case 'error':
			w3.toggleShow("#d_"+id);
			derror = !derror;
			if(derror){
				w3.displayObject("a_"+id,{error:"hide Error panel"});
			} else {
				w3.displayObject("a_"+id,{error:"show Error panel"});
			}
			break;
		case 'ebnfsrfb':
			w3.toggleShow("#d_"+id);
			ebnfsrfb = !ebnfsrfb;
			if(ebnfsrfb){
				w3.displayObject("a_"+id,{ebnfsrfb:"hide EBNF SRFB Editor"});
			} else {
				w3.displayObject("a_"+id,{ebnfsrfb:"show EBNF SRFB Editor"});
			}
			break;
		case 'ebnfsqlite':
			w3.toggleShow("#d_"+id);
			ebnfsqlite = !ebnfsqlite;
			if(ebnfsqlite){
				w3.displayObject("a_"+id,{ebnfsqlite:"hide EBNF SQLITE Editor"});
			} else {
				w3.displayObject("a_"+id,{ebnfsqlite:"show EBNF SQLITE Editor"});
			}
			break;
		case 'ebnfsh':
			w3.toggleShow("#EBNFRailroad");
			ebnfsh = !ebnfsh;
			if(ebnfsh){
				w3.displayObject("a_"+id,{ebnfsh:"hide EBNF railroad"});
			} else {
				w3.displayObject("a_"+id,{ebnfsh:"show EBNF railroad"});
			}
			break;			
		case 'sqlitesrfb':
			w3.toggleShow("#d_"+id);
			sqlite = !sqlite;
			if(sqlite){
				w3.displayObject("a_"+id,{sqlitesrfb:"hide SQLITE SRFB Grammar Editor"});
			} else {
				w3.displayObject("a_"+id,{sqlitesrfb:"show SQLITE SRFB grammar Editor"});
			}
			break;
			
		case 'sqlitesh':
			w3.toggleShow("#SQLITERailroad");
			sqlitesh = !sqlitesh;
			if(sqlitesh){
				w3.displayObject("a_"+id,{sqlitesh:"hide SQLITE railroad"});
			} else {
				w3.displayObject("a_"+id,{sqlitesh:"show SQLITE railroad"});
			}
			break;			
		case 'sqlite':
			w3.toggleShow("#d_"+id);
			sqlite = !sqlite;
			if(sqlite){
				w3.displayObject("a_"+id,{sqlite:"hide SQLITE Editor"});
			} else {
				w3.displayObject("a_"+id,{sqlite:"show SQLITE Editor"});
			}
			break;
	}
}

function refreshebnf(){
	var error=document.getElementById('error');
	var result=document.getElementById('EBNFRailroad');
	refresh(result,error,e_ebnfsrfb,'EBNFRailroad');
}

function refreshsqlite(){
	var error=document.getElementById('error');
	var result=document.getElementById('SQLITERailroad');
	refresh(result,error,e_sqlitesrfb,'SQLITERailroad');
}

function doc(type,node){
	if(type==="NonTerminal"){
		window.location.href = "#";
		window.location.href = "#"+node;
	}
}

function refresh(result,error,editor,resultid){
	root.context.language={};
	root.context.bnf=[];
	window.results.title=[];
	window.results.graph=[];
	window.results.walk=[];
	window.results.context=root.context;
	window.results.state="notset";
	window.results.error=error;
	window.results.context.normalize=SRFB.normalize;
	window.Show=SRFB.Show.bind(window.results);
	result.innerHTML="";
	error.innerHTML="";
	var diags = editor.getValue();
	var scriptref;

	//jslint for errors
	var source = diags;
	source+="\nfunction Show(){}\n";
	for(var fn=0; fn<root.Railroad.fnames.length;fn++){
		source+="\nfunction "+root.Railroad.fnames[fn]+"(){}\n";
	}
	
	/* verify javascript */
	var eresult;
	var options={};
	var jserror=false;
	// var jscheck = jslint(source);  => using jslint library
	// error = jscheck.stop;
	
	/* using esprima */
	try {
		eresult = esprima.parse(source, options);
	} catch (e) {
		jserror=true;
		error.innerHTML  = e.name + ': ' + e.message;;
	}
	/* end using esprima */

	if(!jserror){

	// prepare graphing
	results.state='graphing';
	root.Railroad.SetExports(root.Railroad.graphing,root.Railroad.fnames);
	// comments should be within /* */  double // don't work
	try{
		scriptref = SRFB.injectjs(diags,error);
	} catch(e){
		error.innerHTML="<pre>"+
					    e.stack+"\n"+
						"</pre>";
		return;
	}      
	scriptref.outerHTML="";

	// prepare json
	results.state='walking';
    root.Railroad.SetExports(root.Railroad.walking,root.Railroad.fnames);
    try{
		scriptref = SRFB.injectjs(diags,error);
	} catch(e){
		error.innerHTML="<pre>"+
					    e.stack+"\n"+
						"</pre>";
		return;
	}
	scriptref.outerHTML="";

	// prepare generating
	results.state='generating';
	root.Railroad.SetExports(root.Railroad.generating,root.Railroad.fnames);
	try{
		scriptref = SRFB.injectjs(diags,error);
	} catch(e){
		error.innerHTML="<pre>"+
					    e.stack+"\n"+
						"</pre>";
		return;
	}
	scriptref.outerHTML="";

    // render results
    for(var i=0; i<results.graph.length;i++){
    		var graphout = window.document.createElement('section');
			// <i class="material-icons">home</i>
			var a = window.document.createElement('a');
			a.setAttribute('href','#'+resultid);
			a.setAttribute('id',results.title[i]);
			var icon = window.document.createElement('i'); 
			icon.setAttribute('class','material-icons w3-tiny');
			var ih = window.document.createTextNode('home');
			icon.appendChild(ih);
			a.appendChild(icon);
			result.appendChild(a);			
			graphout.setAttribute('class','w3-responsive');
            graphout.appendChild(results.graph[i].toSVG());
            result.appendChild(graphout);    				
    } 
	} else {
		// display warnings (//jslint)
		/*
		var content="<pre>";		
		for(var i=0; i<jscheck.warnings.length; i++){
			var w = jscheck.warnings[i];
			content+=w.line+":"+w.column+" "+w.message+"\n";
		}
		content+="</pre>";
		error.innerHTML=content;
		*/
	}        
}

function validate(){
	var error=document.getElementById('error');
	var expression = window.e_ebnfsqlite.getValue();
	SRFB.validate('syntax_', results, error, expression, null, false,true);
	window.e_sqlitesrfb.getDoc().setValue(results.context.SRFBfromEBNF);
}

function validatesql(){
	var error=document.getElementById('error');
	var expression = window.e_sqlite.getValue();
	var VSQLITE = window.document.getElementById("VSQLITE");
	SRFB.validate('sql_stmt', results, error, expression, VSQLITE, true,false);
}

</script>
     
</body>
</html> 
